name: MicroPython Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-micropython:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python (for build tools)
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install system dependencies for MicroPython build
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libffi-dev git pkg-config

    - name: Cache MicroPython installation
      id: cache-micropython
      uses: actions/cache@v3
      with:
        path: |
          ~/.pyenv
          ~/.micropython
        key: ${{ runner.os }}-micropython-1.21.0-${{ hashFiles('.github/workflows/micropython-tests.yml') }}

    - name: Try installing MicroPython via pyenv
      id: pyenv-install
      continue-on-error: true
      run: |
        # Install pyenv if not already installed
        if [ ! -d "$HOME/.pyenv" ]; then
          echo "Installing pyenv..."
          curl https://pyenv.run | bash
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init -)"
        else
          echo "pyenv already installed"
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init -)"
        fi
        
        # Try to install micropython-1.21.0
        echo "Attempting to install micropython-1.21.0 via pyenv..."
        pyenv install micropython-1.21.0 || exit 1
        pyenv global micropython-1.21.0
        
        # Verify installation
        micropython --version
        
        # Mark success
        echo "MICROPYTHON_INSTALL_METHOD=pyenv" >> $GITHUB_ENV
        echo "MICROPYTHON_PATH=$(pyenv which micropython)" >> $GITHUB_ENV

    - name: Build MicroPython from source (fallback)
      if: steps.pyenv-install.outcome == 'failure'
      run: |
        echo "pyenv installation failed, building from source..."
        
        # Set installation directory
        MICROPYTHON_DIR="$HOME/.micropython"
        mkdir -p "$MICROPYTHON_DIR"
        
        # Download MicroPython source
        cd /tmp
        wget https://micropython.org/resources/source/micropython-1.21.0.tar.xz
        tar -xf micropython-1.21.0.tar.xz
        cd micropython-1.21.0
        
        # Build mpy-cross (cross-compiler)
        echo "Building mpy-cross..."
        make -C mpy-cross
        
        # Build Unix port of MicroPython
        echo "Building Unix port..."
        cd ports/unix
        make submodules
        make
        
        # Install to custom directory
        cp build-standard/micropython "$MICROPYTHON_DIR/micropython"
        chmod +x "$MICROPYTHON_DIR/micropython"
        
        # Verify installation
        "$MICROPYTHON_DIR/micropython" --version
        
        # Set environment variables
        echo "MICROPYTHON_INSTALL_METHOD=source" >> $GITHUB_ENV
        echo "MICROPYTHON_PATH=$MICROPYTHON_DIR/micropython" >> $GITHUB_ENV

    - name: Verify MicroPython installation
      run: |
        echo "MicroPython installation method: $MICROPYTHON_INSTALL_METHOD"
        echo "MicroPython path: $MICROPYTHON_PATH"
        $MICROPYTHON_PATH --version
        
        # Test basic functionality
        $MICROPYTHON_PATH -c "print('MicroPython is working!')"
        $MICROPYTHON_PATH -c "import sys; print('Python version:', sys.version)"

    - name: Run tests with MicroPython
      run: |
        echo "Running ChipClaw tests with MicroPython..."
        
        # Set MICROPYTHON environment variable for test runner
        export MICROPYTHON="$MICROPYTHON_PATH"
        
        # Run the test runner with MicroPython
        $MICROPYTHON_PATH tests/test_runner.py
        
        if [ $? -eq 0 ]; then
          echo "✓ All tests passed with MicroPython 1.21.0!"
        else
          echo "✗ Some tests failed with MicroPython 1.21.0"
          exit 1
        fi

    - name: Test import main module with MicroPython
      run: |
        # Test that main modules can be imported
        $MICROPYTHON_PATH -c "import sys; sys.path.insert(0, '.'); from chipclaw.utils import get_runtime_info; print('Utils imported successfully')"
        
        echo "✓ Module imports successful with MicroPython 1.21.0!"

  summary:
    runs-on: ubuntu-latest
    permissions: {}
    needs: [test-micropython]
    if: always()
    
    steps:
    - name: Check test results
      run: |
        echo "MicroPython tests completed"
        if [ "${{ needs.test-micropython.result }}" != "success" ]; then
          echo "MicroPython tests failed!"
          exit 1
        fi
        echo "All MicroPython checks passed!"
